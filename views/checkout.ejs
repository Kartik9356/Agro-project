<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
  </head>
  <body class="bg-white font-sans text-gray-800 flex flex-col min-h-screen">
    <%- include('partials/header') %>

    <div class="bg-gray-50 py-8 border-b border-gray-100">
      <div class="container mx-auto px-4">
        <h1 class="text-3xl font-extrabold text-gray-900">Checkout</h1>
      </div>
    </div>

    <section class="py-10">
      <div class="container mx-auto px-4">
        <div
          class="mb-10 bg-gray-50 border-t-2 border-[#4CAF50] p-4 text-gray-600 text-sm"
        >
          <i class="ph ph-tag text-gray-400 text-lg align-middle mr-1"></i>
          Have a coupon?
          <a href="#" class="text-[#4CAF50] font-bold hover:underline"
            >Click here to enter your code</a
          >
        </div>

        <form id="checkout-form">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-12">
            <div>
              <h2
                class="text-xl font-bold text-gray-900 mb-6 uppercase tracking-wide"
              >
                Billing details
              </h2>

              <div class="grid grid-cols-2 gap-6 mb-6">
                <div class="space-y-2">
                  <label class="text-sm font-bold text-gray-700"
                    >First name <span class="text-red-500">*</span></label
                  >
                  <input
                    type="text"
                    id="fname"
                    required
                    class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:border-[#4CAF50] bg-white"
                  />
                </div>
                <div class="space-y-2">
                  <label class="text-sm font-bold text-gray-700"
                    >Last name <span class="text-red-500">*</span></label
                  >
                  <input
                    type="text"
                    id="lname"
                    required
                    class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:border-[#4CAF50] bg-white"
                  />
                </div>
              </div>

              <div class="space-y-2 mb-6">
                <label class="text-sm font-bold text-gray-700"
                  >Country / Region <span class="text-red-500">*</span></label
                >
                <div class="font-bold text-gray-900">India</div>
              </div>

              <div class="space-y-2 mb-6">
                <label class="text-sm font-bold text-gray-700"
                  >Street address <span class="text-red-500">*</span></label
                >
                <input
                  type="text"
                  id="address"
                  required
                  placeholder="House number and street name"
                  class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:border-[#4CAF50] bg-white mb-3"
                />
                <input
                  type="text"
                  id="apartment"
                  placeholder="Apartment, suite, unit, etc. (optional)"
                  class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:border-[#4CAF50] bg-white"
                />
              </div>

              <div class="space-y-2 mb-6">
                <label class="text-sm font-bold text-gray-700"
                  >Town / City <span class="text-red-500">*</span></label
                >
                <input
                  type="text"
                  id="city"
                  required
                  class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:border-[#4CAF50] bg-white"
                />
              </div>

              <div class="space-y-2 mb-6">
                <label class="text-sm font-bold text-gray-700"
                  >State <span class="text-red-500">*</span></label
                >
                <select
                  id="state"
                  class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:border-[#4CAF50] bg-white"
                >
                  <option>Maharashtra</option>
                  <option>Delhi</option>
                  <option>Karnataka</option>
                  <option>Gujarat</option>
                </select>
              </div>

              <div class="space-y-2 mb-6">
                <label class="text-sm font-bold text-gray-700"
                  >PIN Code <span class="text-red-500">*</span></label
                >
                <input
                  type="text"
                  id="pincode"
                  required
                  class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:border-[#4CAF50] bg-white"
                />
              </div>

              <div class="space-y-2 mb-6">
                <label class="text-sm font-bold text-gray-700"
                  >Phone <span class="text-red-500">*</span></label
                >
                <input
                  type="tel"
                  id="phone"
                  required
                  class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:border-[#4CAF50] bg-white"
                />
              </div>

              <div class="space-y-2 mb-6">
                <label class="text-sm font-bold text-gray-700"
                  >Email address <span class="text-red-500">*</span></label
                >
                <input
                  type="email"
                  id="email"
                  required
                  class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:border-[#4CAF50] bg-white"
                />
              </div>
            </div>

            <div>
              <div class="flex items-center gap-2 mb-6">
                <input
                  type="checkbox"
                  id="diffAddress"
                  class="w-4 h-4 text-[#4CAF50] border-gray-300 rounded focus:ring-[#4CAF50]"
                />
                <label
                  for="diffAddress"
                  class="text-xl font-bold text-gray-900 cursor-pointer uppercase tracking-wide"
                  >Ship to a different address?</label
                >
              </div>

              <div class="space-y-2">
                <label class="text-sm font-bold text-gray-700"
                  >Order notes (optional)</label
                >
                <textarea
                  rows="5"
                  id="notes"
                  placeholder="Notes about your order, e.g. special notes for delivery."
                  class="w-full border border-gray-300 rounded px-4 py-3 focus:outline-none focus:border-[#4CAF50] bg-white"
                ></textarea>
              </div>
            </div>
          </div>

          <div class="mb-12">
            <h2 class="text-xl font-bold text-gray-900 mb-6">Your order</h2>
            <div
              class="bg-white border border-gray-200 rounded overflow-hidden"
            >
              <table class="w-full text-left">
                <thead>
                  <tr class="bg-gray-50 border-b border-gray-200">
                    <th class="p-4 font-bold text-gray-700">Product</th>
                    <th class="p-4 font-bold text-gray-700 text-right">
                      Subtotal
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="order-summary-body"
                  class="divide-y divide-gray-100"
                ></tbody>
              </table>
            </div>
          </div>

          <div class="bg-gray-50 p-8 rounded-lg border border-gray-200 mb-8">
            <div class="mb-6">
              <div class="flex items-center gap-3 mb-4">
                <div
                  class="w-4 h-4 rounded-full border-[5px] border-[#D32F2F] bg-white"
                ></div>
                <span class="font-bold text-gray-900">Cash on delivery</span>
              </div>
              <div
                class="bg-gray-200 p-4 text-sm text-gray-600 relative ml-0 md:ml-7 triangle-box"
              >
                Pay with cash upon delivery.
                <style>
                  .triangle-box::before {
                    content: "";
                    position: absolute;
                    top: -16px;
                    left: 10px;
                    border: 8px solid transparent;
                    border-bottom-color: #e5e7eb;
                  }
                </style>
              </div>
            </div>

            <p class="text-sm text-gray-600 mb-6 leading-relaxed">
              Your personal data will be used to process your order, support
              your experience throughout this website, and for other purposes
              described in our
              <a href="#" class="text-[#D32F2F] hover:underline"
                >privacy policy</a
              >.
            </p>

            <div class="flex items-start gap-2 mb-8">
              <input
                type="checkbox"
                id="terms"
                required
                class="mt-1 w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500"
              />
              <label for="terms" class="text-sm text-gray-700">
                I have read and agree to the website
                <a href="#" class="text-[#D32F2F] hover:underline"
                  >terms and conditions</a
                >
                <span class="text-red-500">*</span>
              </label>
            </div>

            <button
              type="submit"
              class="w-full md:w-auto bg-[#D32F2F] hover:bg-[#B71C1C] text-white font-bold py-4 px-10 rounded shadow-lg uppercase tracking-wider transition duration-300"
            >
              Place Order
            </button>
          </div>
        </form>
      </div>
    </section>

    <%- include('partials/footer') %>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        loadOrderSummary();
      });

      function loadOrderSummary() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const tableBody = document.getElementById("order-summary-body");

        // If cart is empty, redirect to shop
        if (cart.length === 0) {
          window.location.href = "/shop";
          return;
        }

        let html = "";
        let grandTotal = 0;

        cart.forEach((item) => {
          const itemTotal = item.price * item.quantity;
          grandTotal += itemTotal;

          html += `
          <tr>
              <td class="p-4 text-gray-600">
                  ${item.name} <strong class="text-gray-900 ml-1">× ${item.quantity}</strong>
                  ${item.unit ? `<br><span class="text-xs text-gray-400">Pack: ${item.unit}</span>` : ""}
              </td>
              <td class="p-4 font-bold text-gray-900 text-right">₹${itemTotal.toFixed(2)}</td>
          </tr>
          `;
        });

        // Add Totals
        html += `
          <tr class="bg-white">
              <td class="p-4 font-bold text-gray-700">Subtotal</td>
              <td class="p-4 font-bold text-gray-900 text-right">₹${grandTotal.toFixed(2)}</td>
          </tr>
          <tr class="bg-white">
              <td class="p-4 font-bold text-gray-700">Shipping</td>
              <td class="p-4 font-medium text-gray-600 text-right">Free Shipping</td>
          </tr>
          <tr class="bg-white border-t border-gray-200">
              <td class="p-4 font-bold text-gray-900 text-lg">Total</td>
              <td class="p-4 font-extrabold text-gray-900 text-xl text-right">₹${grandTotal.toFixed(2)}</td>
          </tr>
        `;

        tableBody.innerHTML = html;
      }

      // HANDLE FORM SUBMISSION
      // HANDLE FORM SUBMISSION
      document
        .getElementById("checkout-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          // 1. Collect Details
          const billingDetails = {
            name:
              document.getElementById("fname").value +
              " " +
              document.getElementById("lname").value,
            address: document.getElementById("address").value,
            city: document.getElementById("city").value,
            state: document.getElementById("state").value,
            zip: document.getElementById("pincode").value,
            phone: document.getElementById("phone").value,
            email: document.getElementById("email").value,
          };

          const cart = JSON.parse(localStorage.getItem("cart")) || [];
          const grandTotal = cart.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0,
          );
          const orderId = Math.floor(Math.random() * 10000) + 1;

          // 2. Create Final Order Object
          const newOrder = {
            id: orderId,
            date: new Date().toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            }),
            total: grandTotal,
            paymentMethod: "Cash on delivery",
            items: cart,
            billing: billingDetails,
            shipping: billingDetails,
          };

          // 3. Show Loading State (Optional but good UX)
          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerText;
          submitBtn.innerText = "Processing...";
          submitBtn.disabled = true;

          // 4. SEND TO SERVER (The New Part)
          fetch("/place-order", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(newOrder),
          })
            .then((response) => response.json())
            .then((data) => {
              // 5. Success! Save to LocalStorage for the "Thank You" page and redirect
              localStorage.setItem(
                "janta_last_order",
                JSON.stringify(newOrder),
              );
              localStorage.removeItem("cart"); // Clear cart
              window.location.href = "/order-confirmation";
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Something went wrong. Please try again.");
              submitBtn.innerText = originalText;
              submitBtn.disabled = false;
            });
        });
    </script>
  </body>
</html>
