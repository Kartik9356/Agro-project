<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
  </head>
  <body class="bg-white font-sans text-gray-800 flex flex-col min-h-screen">
    <%- include('partials/header') %>

    <div class="bg-gray-50 py-10 border-b border-gray-100 mb-8">
      <div class="container mx-auto px-4">
        <h1 class="text-4xl font-extrabold text-gray-900">Cart</h1>
      </div>
    </div>

    <section class="py-8 mb-auto">
      <div class="container mx-auto px-4">
        <div class="overflow-x-auto mb-12">
          <table class="w-full border-collapse min-w-[800px]">
            <thead>
              <tr
                class="border-b border-gray-200 text-left text-gray-600 font-bold"
              >
                <th class="py-4 px-2 w-12"></th>
                <th class="py-4 px-2 w-24"></th>
                <th class="py-4 px-2">Product</th>
                <th class="py-4 px-2">Price</th>
                <th class="py-4 px-2">Quantity</th>
                <th class="py-4 px-2 text-right">Subtotal</th>
              </tr>
            </thead>
            <tbody id="cart-table-body"></tbody>
          </table>

          <div id="empty-cart-msg" class="hidden text-center py-12">
            <i class="ph ph-shopping-cart text-6xl text-gray-300 mb-4"></i>
            <p class="text-xl text-gray-500 font-medium">
              Your cart is currently empty.
            </p>
            <a
              href="/shop"
              class="mt-4 inline-block text-[#4CAF50] font-bold hover:underline"
              >Return to Shop</a
            >
          </div>
        </div>

        <div
          id="cart-actions"
          class="flex flex-col md:flex-row justify-between items-center gap-6 mb-16 border-b border-gray-200 pb-12"
        >
          <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
            <input
              type="text"
              placeholder="Coupon code"
              class="px-4 py-3 border border-gray-300 rounded w-full sm:w-64 focus:outline-none focus:border-[#4CAF50]"
            />
            <button
              class="bg-[#D32F2F] hover:bg-[#B71C1C] text-white font-bold py-3 px-8 rounded uppercase text-sm tracking-wide transition"
            >
              Apply Coupon
            </button>
          </div>
        </div>

        <div id="cart-totals" class="flex justify-end">
          <div class="w-full md:w-1/2 lg:w-1/3">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Cart totals</h2>

            <div class="border border-gray-200 rounded-lg overflow-hidden mb-8">
              <div
                class="flex justify-between items-center p-4 border-b border-gray-100"
              >
                <span class="font-bold text-gray-700">Subtotal</span>
                <span class="text-gray-500 font-medium" id="page-subtotal"
                  >₹0.00</span
                >
              </div>

              <div
                class="flex justify-between p-4 border-b border-gray-100 bg-gray-50"
              >
                <span class="font-bold text-gray-700">Shipping</span>
                <div class="text-right text-sm">
                  <p class="text-gray-500 mb-2">Calculated at checkout</p>
                </div>
              </div>

              <div class="flex justify-between items-center p-6 bg-white">
                <span class="font-bold text-gray-900 text-lg">Total</span>
                <span
                  class="font-extrabold text-gray-900 text-xl"
                  id="page-total"
                  >₹0.00</span
                >
              </div>
            </div>

            <a
              href="/checkout"
              class="block w-full bg-[#D32F2F] hover:bg-[#B71C1C] text-white text-center font-bold py-4 rounded-lg shadow-md uppercase tracking-wider transition duration-300"
            >
              Proceed to Checkout
            </a>
          </div>
        </div>
      </div>
    </section>

    <%- include('partials/footer') %>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        renderCartPage();
      });

      function renderCartPage() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const tableBody = document.getElementById("cart-table-body");
        const emptyMsg = document.getElementById("empty-cart-msg");
        const cartActions = document.getElementById("cart-actions");
        const cartTotals = document.getElementById("cart-totals");

        // 1. Handle Empty Cart State
        if (cart.length === 0) {
          tableBody.innerHTML = "";
          emptyMsg.classList.remove("hidden");
          cartActions.classList.add("hidden");
          cartTotals.classList.add("hidden");
          updatePageTotals(0);
          return; // Stop execution
        }

        // 2. Show Cart Sections if they were hidden
        emptyMsg.classList.add("hidden");
        cartActions.classList.remove("hidden");
        cartTotals.classList.remove("hidden");

        // 3. Generate Table Rows
        let html = "";
        let grandTotal = 0;

        cart.forEach((item, index) => {
          const itemTotal = item.price * item.quantity;
          grandTotal += itemTotal;

          html += `
                <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
                    <td class="py-6 px-2 text-center">
                        <button onclick="removeItem(${index})" class="text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>
                    </td>
                    
                    <td class="py-6 px-2">
                        <div class="w-20 h-20 bg-gray-50 rounded border border-gray-200 overflow-hidden flex items-center justify-center">
                            <img src="${item.image}" alt="${item.name}" class="w-full h-full object-contain mix-blend-multiply">
                        </div>
                    </td>
                    
                    <td class="py-6 px-2">
                        <a href="/product/${item.id}" class="text-[#0073aa] font-medium hover:underline text-lg">
                            ${item.name}
                        </a>
                    </td>
                    
                    <td class="py-6 px-2 text-gray-500 font-medium">
                        ₹${item.price.toFixed(2)}
                    </td>
                    
                    <td class="py-6 px-2">
                        <input type="number" 
                               value="${item.quantity}" 
                               min="1" 
                               onchange="updateQuantity(${index}, this.value)"
                               class="w-16 py-2 px-3 border border-gray-300 rounded text-center text-gray-700 focus:outline-none focus:border-[#4CAF50]">
                    </td>
                    
                    <td class="py-6 px-2 text-right font-bold text-gray-800">
                        ₹${itemTotal.toFixed(2)}
                    </td>
                </tr>
                `;
        });

        tableBody.innerHTML = html;
        updatePageTotals(grandTotal);
      }

      function updatePageTotals(total) {
        document.getElementById("page-subtotal").innerText =
          "₹" + total.toFixed(2);
        document.getElementById("page-total").innerText =
          "₹" + total.toFixed(2);
      }

      // --- ACTIONS ---

      function removeItem(index) {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        cart.splice(index, 1); // Remove item at index
        localStorage.setItem("cart", JSON.stringify(cart));

        // Re-render Page & Header
        renderCartPage();
        updateCartHeader(); // From header.ejs script
      }

      function updateQuantity(index, newQty) {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];

        // Convert to integer and ensure at least 1
        let qty = parseInt(newQty);
        if (qty < 1) qty = 1;

        cart[index].quantity = qty;
        localStorage.setItem("cart", JSON.stringify(cart));

        // Re-render Page & Header
        renderCartPage();
        updateCartHeader(); // From header.ejs script
      }
    </script>
  </body>
</html>
